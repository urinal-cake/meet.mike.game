<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancel Meeting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .cancel-container {
            max-width: 700px;
            margin: 0 auto;
        }
        .cancel-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 2rem;
        }
        .cancel-header {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .info-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }
        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .info-value {
            font-size: 1.1rem;
            color: #333;
        }
        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        .warning-box {
            background: #fff3cd;
            color: #856404;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin: 1.5rem 0;
        }
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        .btn-cancel-meeting {
            background: #dc3545;
            color: white;
            flex: 1;
        }
        .btn-cancel-meeting:hover {
            background: #c82333;
            color: white;
        }
        .btn-keep {
            background: #6c757d;
            color: white;
            flex: 1;
        }
        .btn-keep:hover {
            background: #5a6268;
            color: white;
        }
    </style>
</head>
<body>
    <div class="cancel-container">
        <div class="cancel-card">
            <div id="loadingState" class="loading-spinner">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading booking details...</p>
            </div>

            <div id="errorState" style="display: none;">
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-home me-2"></i>Return to Home
                </a>
            </div>

            <div id="bookingDetails" style="display: none;">
                <div class="cancel-header">
                    <h2><i class="fas fa-calendar-times me-2 text-danger"></i>Cancel Meeting</h2>
                </div>

                <div class="warning-box">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Are you sure you want to cancel this meeting?</strong>
                    <p class="mb-0 mt-2">This action will remove the event from both calendars and cannot be undone.</p>
                </div>

                <div class="info-section">
                    <div class="info-label">Meeting Details</div>
                    <div class="info-value">
                        <div><strong id="meetingType"></strong> (<span id="duration"></span> minutes)</div>
                        <div class="mt-2">
                            <i class="fas fa-calendar me-2"></i><span id="date"></span>
                        </div>
                        <div class="mt-2">
                            <i class="fas fa-clock me-2"></i><span id="time"></span>
                            <span class="text-muted ms-2" id="timezone"></span>
                        </div>
                        <div class="mt-2">
                            <i class="fas fa-user me-2"></i><span id="name"></span>
                        </div>
                    </div>
                </div>

                <div id="responseMessage" style="display: none;"></div>

                <div class="action-buttons" id="actionButtons">
                    <button class="btn btn-cancel-meeting btn-lg" id="cancelBtn">
                        <i class="fas fa-times me-2"></i>Yes, Cancel Meeting
                    </button>
                    <a href="/" class="btn btn-keep btn-lg">
                        <i class="fas fa-check me-2"></i>Keep Meeting
                    </a>
                </div>
            </div>

            <div id="successState" style="display: none;">
                <div class="success-message">
                    <i class="fas fa-check-circle fa-3x mb-3" style="color: #28a745;"></i>
                    <h3>Meeting Cancelled</h3>
                    <p>The meeting has been cancelled and removed from both calendars.</p>
                    <p>Both parties have been notified via email.</p>
                    <a href="/" class="btn btn-primary mt-3">
                        <i class="fas fa-home me-2"></i>Return to Home
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            showError('No cancellation token provided. Please use the link from your confirmation email.');
        } else {
            loadBooking();
        }

        async function loadBooking() {
            try {
                const response = await fetch(`/api/booking?token=${encodeURIComponent(token)}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load booking');
                }

                displayBooking(data);
            } catch (error) {
                showError(error.message);
            }
        }

        function displayBooking(booking) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('bookingDetails').style.display = 'block';

            document.getElementById('meetingType').textContent = booking.meetingTypeTitle;
            document.getElementById('duration').textContent = booking.durationMinutes;
            document.getElementById('date').textContent = formatDate(booking.date);
            document.getElementById('time').textContent = booking.time;
            document.getElementById('timezone').textContent = `(${booking.timezone})`;
            document.getElementById('name').textContent = booking.name;

            document.getElementById('cancelBtn').addEventListener('click', handleCancel);
        }

        function formatDate(dateStr) {
            // Parse date string in format YYYY-MM-DD
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        async function handleCancel() {
            if (!confirm('Are you absolutely sure you want to cancel this meeting? This cannot be undone.')) {
                return;
            }

            const cancelBtn = document.getElementById('cancelBtn');
            const actionButtons = document.getElementById('actionButtons');
            
            cancelBtn.disabled = true;
            cancelBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cancelling...';

            try {
                const response = await fetch('/api/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to cancel meeting');
                }

                document.getElementById('bookingDetails').style.display = 'none';
                document.getElementById('successState').style.display = 'block';
            } catch (error) {
                showResponseError(error.message);
                cancelBtn.disabled = false;
                cancelBtn.innerHTML = '<i class="fas fa-times me-2"></i>Yes, Cancel Meeting';
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function showResponseError(message) {
            const responseMessage = document.getElementById('responseMessage');
            responseMessage.className = 'error-message';
            responseMessage.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
            responseMessage.style.display = 'block';
        }
    </script>
</body>
</html>
